---
- hosts:
  - osds
  
  #gather_facts: false
  #any_errors_fatal: true
  #become: true
 
  vars_files:
    - ceph_vars.yml
  
  pre_tasks:
    - name: get hostname
      shell: hostname

    # ip v6 /sbin/ifconfig enp88s0f0 | awk '/inet6/ {print $2}'|awk 'NR==2 {print $1}'
    # ipv 4/sbin/ifconfig enp88s0f0 | awk '/inet/ {print $2}' | cut -f2 -d ":" |awk 'NR==1 {print $1}'
    # 子网掩码 /sbin/ifconfig enp88s0f0 | awk '/netmask/ {print $4}'
    - name: get public node_addr
      shell: /sbin/ifconfig {{public_interface}} | awk '/inet/ {print $2}' | cut -f2 -d ":" |awk 'NR==1 {print $1}'
      register: node_addr

    - name: cp ceph.repo
      shell: scp wget -P /etc/yum.repos.d/ http://${mirror_node}/repo/centos8/ceph.repo
     
    - name: install
      shell: yum install -y ceph-base ceph-common ceph-osd librados2 libradosstriper1 librbd1 python3-ceph-argparse python3-rados python3-rbd python3-ceph-common

    - name: clean ceph.repo
      shell: rm -rf /etc/yum.repos.d/ceph.repo
    
    - name : cp form admin
      shell: scp root@{{admin_node}}:/etc/ceph/{{cluster_name}}.conf root@{{admin_addr}}:/tmp/{{cluster_name}}.conf.sample
      delegate_to: "{{admin_node}}"
 
  tasks:
    - name: cp admin key
      shell: scp root@{{admin_node}}:/etc/ceph/{{cluster_name}}.client.admin.keyring root@{{node_addr}}/etc/ceph/{{cluster_name}}.client.admin.keyring

    - name: cp osd bootstrap keying
      shell: scp root@{{admin_node}}:/var/lib/ceph/bootstrap-osd/{{cluster_name}}.keyring root@{{node_addr}}:/var/lib/ceph/bootstrap-osd/{{cluster_name}}.keyring
    
    - name: cp disk prepare
      shell: scp root@{{admin_node}}:/var/lib/ceph/osd/tools/prepare_osd.sh root@{{node_addr}}:/tmp/prepare_osd.sh

    - name:  execute prepare script
      script: /tmp/prepare_osd.sh

    - name: create conf
      shell: sh /tmp/generate_ceph_conf_add_osd.sh /tmp/{{cluster_name}}.conf.sample

    - name: back conf
      shell: scp root@{{admin_addr}}:/etc/ceph/{{cluster_name}}.conf root@{{admin_node}}:/etc/ceph/{{cluster_name}}.conf.sample

    - block: 
      - name: enable osd service
        shell: systemctl enable ceph-osd.target
      
      - name: start osd service
        shell: systemctl start ceph-osd.target
